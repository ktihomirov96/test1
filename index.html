
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –∏–∑–¥–µ–ª–∏—è</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; }
    nav { width: 220px; background: #1e3a5f; color: white; height: 100vh; padding: 10px; box-sizing: border-box; }
    nav a { display: block; padding: 10px; color: white; text-decoration: none; }
    nav a.active { background: #3b82f6; }
    main { flex: 1; padding: 20px; background: #f9fafb; }
    section { display: none; }
    section.active { display: block; }
    input, select { margin: 4px; padding: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
  </style>
</head>
<body>
  <nav>
    <div style="font-weight: bold; margin-bottom: 20px;">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –∏–∑–¥–µ–ª–∏—è</div>
    <a href="#" class="nav-link active" data-target="home">–ù–∞—á–∞–ª–æ</a>
    <a href="#" class="nav-link" data-target="offers">–û—Ñ–µ—Ä—Ç–∏ –∏ —Ä–µ–º–æ–Ω—Ç–∏</a>
    <a href="#" class="nav-link" data-target="warehouse">–°–∫–ª–∞–¥</a>
    <a href="#" class="nav-link" data-target="users">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</a>
  </nav>
  <main>
    <section id="home" class="active">
      <h2>–ß–∞—Ç</h2>
      <input id="chatUsername" placeholder="–í–∞—à–µ—Ç–æ –∏–º–µ" />
      <div id="chatBox" style="height:200px; overflow:auto; border:1px solid #ccc; margin:10px 0;"></div>
      <input id="chatInput" placeholder="–°—ä–æ–±—â–µ–Ω–∏–µ" />
      <button onclick="sendWS()">–ò–∑–ø—Ä–∞—Ç–∏</button>
    </section>

    <section id="offers">
      <h2>–î–æ–±–∞–≤–∏ –æ—Ñ–µ—Ä—Ç–∞</h2>
      <input id="project" placeholder="–ü—Ä–æ–µ–∫—Ç ‚Ññ">
      <input id="matrixNo" placeholder="–ú–∞—Ç—Ä–∏—Ü–∞">
      <input id="client" placeholder="–ö–ª–∏–µ–Ω—Ç">
      <input id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
      <input id="dueDate" type="date">
      <input id="price" placeholder="–¶–µ–Ω–∞">
      <input id="email" placeholder="Email">
      <select id="priority"><option>–ù–∏—Å–∫–∞</option><option>–°—Ä–µ–¥–Ω–∞</option><option>–í–∏—Å–æ–∫–∞</option></select>
      <input type="file" id="imageUpload">
      <button onclick="submitOffer()">–ó–∞–ø–∞–∑–∏</button>
      <table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ú–∞—Ç—Ä–∏—Ü–∞</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ä–æ–∫</th><th>–¶–µ–Ω–∞</th><th>Email</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°–Ω–∏–º–∫–∞</th><th></th></tr></thead>
      <tbody id="offersTable"></tbody></table>
    </section>

    <section id="warehouse">
      <h2>–°–∫–ª–∞–¥</h2>
      <input id="stockMatrix" placeholder="–ù–æ–º–µ—Ä –Ω–∞ –º–∞—Ç—Ä–∏—Ü–∞">
      <input id="stockQty" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
      <button onclick="addStock()">–î–æ–±–∞–≤–∏</button>
      <ul id="stockList"></ul>
    </section>

    <section id="users">
      <h2>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h2>
      <p id="userList">‚úì –í–∏–µ —Å—Ç–µ –æ–Ω–ª–∞–π–Ω</p>
    </section>
  </main>

  <script>
    let ws;
    function initNav() {
      document.querySelectorAll(".nav-link").forEach(link => {
        link.addEventListener("click", e => {
          e.preventDefault();
          document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
          link.classList.add("active");
          const target = link.getAttribute("data-target");
          document.querySelectorAll("main section").forEach(sec => sec.classList.remove("active"));
          document.getElementById(target).classList.add("active");
        });
      });
    }

    function setupWS() {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const host = location.hostname === "localhost" ? "localhost:3000" : location.host;
      ws = new WebSocket(proto + "://" + host);
      ws.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.textContent = msg.timestamp.slice(11,16) + " ‚Äì " + msg.username + ": " + msg.text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      };
    }

    function sendWS() {
      const name = document.getElementById("chatUsername").value;
      const input = document.getElementById("chatInput");
      if (!name || !input.value) return;
      ws.send(JSON.stringify({ username: name, text: input.value }));
      input.value = "";
    }

    function submitOffer() {
      const data = {
        project: document.getElementById("project").value,
        matrixNo: document.getElementById("matrixNo").value,
        client: document.getElementById("client").value,
        description: document.getElementById("description").value,
        dueDate: document.getElementById("dueDate").value,
        price: document.getElementById("price").value,
        email: document.getElementById("email").value,
        priority: document.getElementById("priority").value,
        image: ""
      };
      const file = document.getElementById("imageUpload").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          data.image = e.target.result;
          sendOffer(data);
        };
        reader.readAsDataURL(file);
        return;
      }
      sendOffer(data);
    }

    function sendOffer(data) {
      fetch("/api/offers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(() => loadOffers());
    }

    function loadOffers() {
      fetch("/api/offers").then(res => res.json()).then(data => {
        const table = document.getElementById("offersTable");
        table.innerHTML = "";
        data.forEach(o => {
          const row = document.createElement("tr");
          const color = o.priority === "–í–∏—Å–æ–∫–∞" ? "#f87171" : o.priority === "–°—Ä–µ–¥–Ω–∞" ? "#facc15" : "#34d399";
          row.innerHTML = `
            <td>${o.project}</td><td>${o.matrixNo}</td><td>${o.client}</td>
            <td>${o.description}</td><td>${o.dueDate}</td><td>${o.price}</td>
            <td>${o.email}</td><td style="background:${color}">${o.priority}</td>
            <td><img src="${o.image}" /></td>
            <td><button onclick="deleteOffer(${o.id})">–ò–∑—Ç—Ä–∏–π</button></td>`;
          table.appendChild(row);
        });
      });
    }

    function deleteOffer(id) {
      fetch("/api/offers/" + id, { method: "DELETE" }).then(() => loadOffers());
    }

    function addStock() {
      const m = document.getElementById("stockMatrix").value;
      const q = document.getElementById("stockQty").value;
      const li = document.createElement("li");
      li.textContent = `–ú–∞—Ç—Ä–∏—Ü–∞ ${m} ‚Äì ${q} –±—Ä.`;
      document.getElementById("stockList").appendChild(li);
    }

    window.onload = () => {
      initNav();
      setupWS();
      loadOffers();
    };
  </script>
</body>
</html>
