
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –∏–∑–¥–µ–ª–∏—è</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    nav {
      width: 240px; background: #1e3a5f; color: white; padding: 20px; box-sizing: border-box;
    }
    nav h2 { margin-top: 0; font-size: 18px; }
    nav a {
      display: block; padding: 10px; color: white; text-decoration: none;
      border-radius: 4px; margin-bottom: 5px;
    }
    nav a.active, nav a:hover { background: #3b82f6; }
    main {
      flex: 1; background: #f3f4f6; padding: 20px; overflow-y: auto;
    }
    section { display: none; }
    section.active { display: block; }
    input, select, button {
      padding: 8px; margin: 5px 0; width: 100%;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    img { max-width: 60px; }
  </style>
</head>
<body>
  <nav>
    <h2>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –∏–∑–¥–µ–ª–∏—è</h2>
    <a href="#" class="nav-link active" data-target="home">–ù–∞—á–∞–ª–æ</a>
    <a href="#" class="nav-link" data-target="offers">–û—Ñ–µ—Ä—Ç–∏ –∏ —Ä–µ–º–æ–Ω—Ç–∏</a>
    <a href="#" class="nav-link" data-target="warehouse">–°–∫–ª–∞–¥</a>
    <a href="#" class="nav-link" data-target="users">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</a>
  </nav>
  <main>
    <section id="home" class="active">
      <h2>–ß–∞—Ç</h2>
      <input id="chatUsername" placeholder="–ò–º–µ">
      <input id="chatInput" placeholder="–°—ä–æ–±—â–µ–Ω–∏–µ">
      <button onclick="sendWS()">–ò–∑–ø—Ä–∞—Ç–∏</button>
      <div id="chatBox" style="height:200px; border:1px solid #ccc; overflow:auto; margin-top:10px;"></div>
    </section>
    <section id="offers">
      <h2>–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –æ—Ñ–µ—Ä—Ç–∞</h2>
      <input id="project" placeholder="–ü—Ä–æ–µ–∫—Ç"><input id="matrixNo" placeholder="–ú–∞—Ç—Ä–∏—Ü–∞">
      <input id="client" placeholder="–ö–ª–∏–µ–Ω—Ç"><input id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
      <input id="dueDate" type="date"><input id="price" placeholder="–¶–µ–Ω–∞">
      <input id="email" placeholder="Email"><select id="priority">
        <option>–ù–∏—Å–∫–∞</option><option>–°—Ä–µ–¥–Ω–∞</option><option>–í–∏—Å–æ–∫–∞</option></select>
      <input type="file" id="imageUpload"><button onclick="submitOffer()">–ó–∞–ø–∞–∑–∏</button>
      <table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ú–∞—Ç—Ä–∏—Ü–∞</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ä–æ–∫</th><th>–¶–µ–Ω–∞</th><th>Email</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°–Ω–∏–º–∫–∞</th></tr></thead>
      <tbody id="offersTable"></tbody></table>
    </section>
    <section id="warehouse">
      <h2>–°–∫–ª–∞–¥</h2>
      <input id="stockMatrix" placeholder="–ú–∞—Ç—Ä–∏—Ü–∞">
      <input id="stockDeadline" type="date">
      <button onclick="addStock()">–î–æ–±–∞–≤–∏</button>
      <ul id="stockList"></ul>
    </section>
    <section id="users">
      <h2>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h2>
      <p>‚úì –í–∏–µ —Å—Ç–µ –æ–Ω–ª–∞–π–Ω</p>
    </section>
  </main>
  <script>
    document.querySelectorAll(".nav-link").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
        document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
        link.classList.add("active");
        document.getElementById(link.dataset.target).classList.add("active");
      });
    });

    const proto = location.protocol === "https:" ? "wss" : "ws";
    const host = location.hostname === "localhost" ? "localhost:3000" : location.host;
    const ws = new WebSocket(proto + "://" + host);
    ws.onmessage = e => {
      const m = JSON.parse(e.data);
      const box = document.getElementById("chatBox");
      if (box) box.innerHTML += m.timestamp.slice(11,16) + " ‚Äì " + m.username + ": " + m.text + "<br>";
    };
    function sendWS() {
      const u = document.getElementById("chatUsername").value;
      const t = document.getElementById("chatInput").value;
      if (u && t) ws.send(JSON.stringify({ username: u, text: t }));
      document.getElementById("chatInput").value = "";
    }

    function submitOffer() {
      const data = {
        project: project.value, matrixNo: matrixNo.value, client: client.value,
        description: description.value, dueDate: dueDate.value, price: price.value,
        email: email.value, priority: priority.value, image: ""
      };
      const file = imageUpload.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => { data.image = e.target.result; sendOffer(data); };
        reader.readAsDataURL(file); return;
      }
      sendOffer(data);
    }
    function sendOffer(data) {
      fetch("/api/offers", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(() => loadOffers());
    }
    function loadOffers() {
      fetch("/api/offers").then(res => res.json()).then(data => {
        offersTable.innerHTML = "";
        data.forEach(o => {
          let color = o.priority==="–í–∏—Å–æ–∫–∞"?"#f87171":o.priority==="–°—Ä–µ–¥–Ω–∞"?"#facc15":"#34d399";
          offersTable.innerHTML += `<tr><td>${o.project}</td><td>${o.matrixNo}</td><td>${o.client}</td>
            <td>${o.description}</td><td>${o.dueDate}</td><td>${o.price}</td><td>${o.email}</td>
            <td style="background:${color}">${o.priority}</td><td><img src="${o.image}" /></td></tr>`;
        });
      });
    }

    function addStock() {
      const m = document.getElementById("stockMatrix").value;
      const d = document.getElementById("stockDeadline").value;
      const now = new Date(), end = new Date(d);
      const days = Math.ceil((end - now)/(1000*60*60*24));
      let color = "#34d399"; if (days <= 7) color = "#facc15"; if (days <= 3) color = "#f87171";
      const li = document.createElement("li");
      li.style.background = color;
      li.textContent = `–ú–∞—Ç—Ä–∏—Ü–∞ ${m} ‚Äì –ö—Ä–∞–µ–Ω —Å—Ä–æ–∫: ${d} (${days} –¥–Ω–∏)`;
      document.getElementById("stockList").appendChild(li);
    }

    loadOffers();
  </script>
</body>
</html>
